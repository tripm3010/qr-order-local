name: Local Deployment (Self-hosted)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy-local:
    # Chạy trên máy ảo local của bạn (Self-hosted Runner)
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build and Deploy
      # [QUAN TRỌNG] Truyền Secret vào biến môi trường tại đây
      # Docker Compose sẽ đọc biến này để thay thế cho ${DOCKER_USERNAME} trong file yml
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      run: |
        # Di chuyển vào thư mục chứa code
        cd $GITHUB_WORKSPACE
        
        # Tạo thư mục uploads nếu chưa có và cấp quyền
        mkdir -p uploads
        chmod 777 uploads

        # Tắt container cũ
        # Truyền biến môi trường trực tiếp để đảm bảo nó tìm đúng tên image/container cũ
        DOCKER_USERNAME=$DOCKER_USERNAME docker compose down

        # Build và chạy container mới
        # Cờ --build để bắt buộc build lại image từ source code mới nhất
        # Biến $DOCKER_USERNAME đã được set ở phần env: bên trên
        docker compose up -d --build
        
        # Xóa các image rác (dangling images) để tiết kiệm dung lượng ổ cứng
        docker image prune -f
